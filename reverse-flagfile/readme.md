

file命令支持自定义文件格式，并实现了一些opcode实现相关的解析操作。详细内容参考 https://man7.org/linux/man-pages/man4/magic.4.html

生成opcode的代码如下

```python3
#!/usr/bin/env python3
from pwn import *
flag = "flag{_oh_yes_you_got_the_flag___^_^__}"
# 32
flag_raw = flag[5:-1].encode("utf8")
random_key = []
order_key = list(range(5,37))
random.shuffle(order_key)
for i in range(32):
    random_key.append(randint(0,0xff))

template = "0 string flag{\n"
raw = b""
level=1
for i in range(32):
    template += "%s0x%x leshort^%d %d\n"%(">"*level,64 + i*2,random_key[i]^order_key[i],random_key[i])
    raw += p16(order_key[i])
    level+=1

for i in range(32):
    index = order_key[i] - 5
    s = randint(0,0xff)
    template += "%s(0x%x.b) byte^%d %d\n"%(">"*level,64+i*2,s,flag_raw[index] ^ s)
    level += 1

template += "%s37 string } yes, it's a flag!"%(">"*level)
print(template)


f = {
    0:flag.encode("utf8"),
    0x40:raw
}
wtf = fit(f,filler=b"\x00")



write("flag.bin",wtf)
write("flag.magic",template)
```

生成的magic代码如下，这里 `>` 表示分支指令，整个校验过程是一个连续的if判断，如果走到最后，能输出`yes, it's a flag!`
```
0 string flag{
>0x40 leshort^130 163
>>0x42 leshort^80 85
>>>0x44 leshort^188 179
>>>>0x46 leshort^221 197
>>>>>0x48 leshort^161 173
>>>>>>0x4a leshort^198 211
>>>>>>>0x4c leshort^108 102
>>>>>>>>0x4e leshort^83 72
>>>>>>>>>0x50 leshort^111 117
>>>>>>>>>>0x52 leshort^58 26
>>>>>>>>>>>0x54 leshort^63 29
>>>>>>>>>>>>0x56 leshort^114 96
>>>>>>>>>>>>>0x58 leshort^52 34
>>>>>>>>>>>>>>0x5a leshort^165 188
>>>>>>>>>>>>>>>0x5c leshort^137 157
>>>>>>>>>>>>>>>>0x5e leshort^205 221
>>>>>>>>>>>>>>>>>0x60 leshort^209 242
>>>>>>>>>>>>>>>>>>0x62 leshort^54 49
>>>>>>>>>>>>>>>>>>>0x64 leshort^156 129
>>>>>>>>>>>>>>>>>>>>0x66 leshort^247 230
>>>>>>>>>>>>>>>>>>>>>0x68 leshort^141 139
>>>>>>>>>>>>>>>>>>>>>>0x6a leshort^42 35
>>>>>>>>>>>>>>>>>>>>>>>0x6c leshort^170 167
>>>>>>>>>>>>>>>>>>>>>>>>0x6e leshort^56 43
>>>>>>>>>>>>>>>>>>>>>>>>>0x70 leshort^0 30
>>>>>>>>>>>>>>>>>>>>>>>>>>0x72 leshort^144 152
>>>>>>>>>>>>>>>>>>>>>>>>>>>0x74 leshort^10 46
>>>>>>>>>>>>>>>>>>>>>>>>>>>>0x76 leshort^250 241
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0x78 leshort^137 149
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0x7a leshort^165 171
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0x7c leshort^51 44
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>0x7e leshort^55 32
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x40.b) byte^117 42
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x42.b) byte^105 54
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x44.b) byte^189 200
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x46.b) byte^223 128
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x48.b) byte^197 154
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x4a.b) byte^171 223
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x4c.b) byte^234 143
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x4e.b) byte^74 43
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x50.b) byte^204 160
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x52.b) byte^52 106
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x54.b) byte^64 30
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x56.b) byte^255 144
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x58.b) byte^20 124
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x5a.b) byte^0 102
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x5c.b) byte^39 120
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x5e.b) byte^48 111
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x60.b) byte^40 119
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x62.b) byte^215 191
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x64.b) byte^228 187
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x66.b) byte^36 67
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x68.b) byte^58 85
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x6a.b) byte^218 163
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x6c.b) byte^161 216
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x6e.b) byte^83 39
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x70.b) byte^87 8
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x72.b) byte^173 242
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x74.b) byte^87 8
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x76.b) byte^123 8
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x78.b) byte^192 167
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x7a.b) byte^251 148
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x7c.b) byte^164 251
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>(0x7e.b) byte^67 38
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>37 string } yes, it's a flag!
```

注意这里生成的flag文件不止是一段字符串，后面需要包含一段字节流，才能让file命令正确打印

```bash
$ xxd flag
00000000: 666c 6167 7b5f 6f68 5f79 6573 5f79 6f75  flag{_oh_yes_you
00000010: 5f67 6f74 5f74 6865 5f66 6c61 675f 5f5f  _got_the_flag___
00000020: 5e5f 5e5f 5f7d 0000 0000 0000 0000 0000  ^_^__}..........
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 1900 0800 1200 1400 1b00 1f00 1e00 1a00  ................
00000050: 0700 0d00 0500 0b00 1000 0900 2200 2000  ............". .
00000060: 1600 0a00 1300 1700 1800 0f00 1c00 2400  ..............$.
00000070: 0c00 2100 1100 0600 0e00 2300 1500 1d00  ..!.......#.....

$ file -m flag.mgc flag
flag: yes, it's a flag!
```

当然file.mgc文件的编码有点简单，这导致部分队伍分析字节码，可以直接猜出来flag (≖＿≖)✧。如果能加一些混淆代码，应该效果会更好。





