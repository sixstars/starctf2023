from Crypto.Util.number import *
from secret import flag
import hashlib

a = 43
b = 26
p = 2^a*3^b - 1
assert p in Primes()
K.<i> = GF(p^2, modulus=x^2+1)
E = EllipticCurve(K, [0,6,2,1,-1])

Pa = E(0)
while (2^(a-1))*Pa == 0:
    Pa = 3^b * E.random_point()
Qa = Pa
while Pa.weil_pairing(Qa, 2^a)^(2^(a-1)) == 1:
    Qa = 3^b * E.random_point()
Pb = E(0)
while (3^(b-1))*Pb == 0:
    Pb = 2^a * E.random_point()
Qb = Pb
while Pb.weil_pairing(Qb, 3^b)^(3^(b-1)) == 1:
    Qb = 2^a * E.random_point()
print(Pa,Qa,Pb,Qb)

S = randint(0, 2^a-1)
R = Pa + S * Qa
phi = E.isogeny(R, algorithm='factored')
Ea, phiPb, phiQb = phi.codomain(), phi(Pb), phi(Qb)
print(phiPb,phiQb)
T = randint(0, 3^b-1)
R = Pb + T * Qb
psi = E.isogeny(R, algorithm='factored')
Eb, psiPa, psiQa = psi.codomain(), psi(Pa), psi(Qa)
print(psiPa,psiQa)
psib = Eb.isogeny(psiPa + S*psiQa, algorithm='factored')
Pab,Qab=psib(psiPa),psib(psiQa)
print(Pab,Qab)

enc=bytes_to_long(hashlib.sha256(b'%d-%d'%(S,T)).digest())^^bytes_to_long(flag)
print(enc)

'''
(378814515939412227134279*i + 6954868428680463835427988 : 8630179184318098642344209*i + 3001529297627963651661752 : 1) (11208403457069450597412333*i + 2359491166389018232980278 : 19401356367187226074788823*i + 20693102079445363728026532 : 1) (5674951884033580986929328*i + 22196580432087361180000116 : 20862518855148986213240156*i + 9130839294602837494568010 : 1) (5455836431980736996770539*i + 16359980490061831619863024 : 6423941456508027672925842*i + 20988014422044297525954324 : 1)
(2227297525031670268262704*i + 1002106657841888291271373 : 15214798914508850872004971*i + 12557446591322302477900041 : 1) (12063038170712632869620621*i + 13573417922891759527293224 : 10661249940441518528681763*i + 18033205806394179376376559 : 1)
(18552761375306700000780232*i + 11706513759831085968051260 : 4907799477130153153831715*i + 7111621111852599259699863 : 1) (18469028642447718646001130*i + 17194519307458154866291301 : 18403779696286771725039680*i + 16098606584135027712232925 : 1)
(21997468988893649835210136*i + 15932964954245548951202309 : 4125812148311464880582524*i + 884317838454914617649300 : 1) (18776398650898678020978222*i + 20800280545780923474516614 : 11677901230203763916636441*i + 2634837966409670014323413 : 1)
61342172857817274763879092151723381200687807188898834158661666331240551751402
'''