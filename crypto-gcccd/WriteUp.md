# 题目解析
>本题主要考察基础密码算法的安全性问题，灵感来自平时写代码碰到的递归溢出报错。

题目设置了两个误导项，一个是enc函数，简单地将结果进行了pow加密，不过p-1光滑，可以轻松求解dlp。其次是给出了几种可能的gcd泄露方式，比如gcd(a,m)，可以通过爆破分解m的小因子。但一般m存在大素数因子，且题目有时间限制，基本不可行。至于gcd(gcd(a,m),b)，目前也没有可泄露的方法。（如果有大佬研究出来欢迎交流）

除去这两个误导项，剩下的就是本题的核心考点，这里我暂时称之为：**基于递归溢出的二分攻击**。

gcd算法是密码学中的基础算法，一般有辗转相除法和更相减损法两种实现。在大部分教程中，对这两种算法都采用递归实现，这就导致了可能的安全性问题。当递归层数过多时，会导致栈溢出。而像python这种语言，会对函数调用层数判断，默认达到1000时抛出递归溢出错误。题目用try-catch对整个交互流程进行处理，在处理整数转换等异常时也隐含了对递归溢出错误的处理，从而让选手可以判断出本次交互是否存在递归溢出错误。

下面我们从简单情形出发，对于更相减损法，很容易产生递归溢出，比如 $a=1001,b=1$ ，显然递归层数会达到1000。对于辗转相除法，我们记函数 $d(a,b)$ 为gcd(a,b)的递归层数，首先可以得到以下几个简单性质：
1. $d(k,0)=1$
2. $d(a,b)=d(b,a\mod b)+1 \quad (b>0)$
3. $d(ka,kb)=d(a,b) \quad (k>0)$
4. $d(kb+a,b)=d(b,a)+1 \quad (b,k>0)$

因此，假设我们有初始数对 $(a_{i+1},a_i)$ ，可以通过构造 $(k_i*a_i+a_{i+1},a_{i+1})$ 来获得递归层数更高的数对。当 $(a_1,a_0)=(1,0), k_i=1$ 时，可以发现这就是斐波那契数列。记斐波那契数列的第 $i$ 项为 $F(i)$ ，则有：

$$ d(F(i+1),F(i)) = i$$

因此，若取 $a=F(1001),b=F(1000)$ ，则会造成辗转相除法的递归溢出。

那么如何利用这一点呢？在题目的代码实现中有一点十分突兀，及对gcd递归调用进行了函数传参，这其实是为了形成递归调用链，使得 $d(a,b,m) = d(a,b) + d(gcd(a,b),m)$ 。此时，我们可以通过控制 $d(a,b)$ 来对 $d(gcd(a,b),m)$ 的信息有一个布尔判断。取 $a=c F(i+1),b=c F(i)$ ，则 $gcd(a,b)=c, d(a,b)=i$ ，可以通过遍历 $i$ 并结合 $i+d(gcd(a,b),m) \geq 1000$ 时递归溢出报错这一特征得到 $d(gcd(a,b),m)$ 的具体值，从而尝试还原 $m$ 。不过这种方法复杂度较高，下面我们考虑一种更快的二分算法。

我们先考虑 $c \leq m$ 时的情形。
1. 假设 $2^k|m$ ，则 $d(2^k,m)=d(m,2^k)=d(2^k,0)+1=2$ ，否则 $d(2^k,m)>2$
2. 若 $2^k|m$ 成立且 $2^{k+1}|m$ 不成立，则 $m\mod 2^{k+1}=2^k$
3. 记 $m_k=m\mod 2^k$ ，若已知 $m_k$ ，则 $m_{k+1}=m_k$ 或 $m_{k+1}=m_k+2^k$
4. $d(2^{k+1},m) = d(m,2^{k+1})+1 = d(2^{k+1},m\mod 2^{k+1})+2$

依次取 $c=2^{k+1}$ ，则 $d(2^{k+1},m) = d(2^{k+1},m_k)+2$ 或 $d(2^{k+1},m) = d(2^{k+1},m_k+2^k)+2$ ，而 $d(2^{k+1},m_k) \neq d(2^{k+1},m_k+2^k)$ 。（这里暂时无法给出理论证明，不过经实验k<16时均成立，故猜想其成立，感兴趣的选手可以尝试证明）因此，当 $m_k$ 已知时，就可以通过判断 $d(2^{k+1},m)$ 来还原 $m_k$ ，进而逐位还原 $m$ （除了最高位）。

还原 $m$ 最高位时， $c>m$ ，情况会复杂一些。不过由于flag格式固定，最高几位其实都是已知的。我们还原出`CTF{`字样即可终止算法。

由于题目只给了60秒的交互时间，可以在逐位还原时进一步优化条件，最终交互几百次就能还原flag。

# 解题脚本
solution.py

# PS
即使将gcd的递归算法改为递推算法，gcd层数的差异也会使得部分参数可控下的侧信道攻击成为可能。很多密码算法中都有gcd这一基础过程，感兴趣的选手可以深入研究研究，说不定能发一篇文章。（滑稽）
